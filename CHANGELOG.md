# 更新日志

## [v3.1.0] - 2025-10-29

### 新增功能

#### 1. 任务重试功能
- ✅ 支持失败或取消的任务重新执行
- ✅ 前端增加"重试"按钮
- ✅ API 端点: `POST /api/tasks/{task_id}/retry`
- ✅ 保留原任务配置，创建新的任务实例

#### 2. 任务列表分页
- ✅ 实现服务器端分页
- ✅ 每页显示10条记录
- ✅ API 端点: `GET /api/tasks?limit=10&offset=0`
- ✅ 前端使用表格展示任务列表

#### 3. 资源预览功能
- ✅ 视频/音频在线播放
- ✅ 字幕内容按时间轴展示
- ✅ 点击预览按钮自动滚动并播放
- ✅ 支持所有下载文件类型的预览

#### 4. 资源类型标签
- ✅ 任务列表显示资源类型标签（视频、音频、字幕）
- ✅ 使用不同颜色区分不同资源类型
- ✅ 后端API返回下载配置字段

#### 5. 单文件重新下载
- ✅ 支持单独重新下载失败的文件
- ✅ 文件级别的状态管理（pending, processing, completed, failed）
- ✅ 失败文件显示错误信息和重试按钮
- ✅ API 端点: `POST /api/tasks/{task_id}/files/{file_type}/retry`

#### 6. 任务重新生成
- ✅ 完成的任务可以重新生成（使用相同配置）
- ✅ 详情页面增加"重新生成"按钮

#### 7. SPA 路由支持
- ✅ 所有API端点统一使用 `/api` 前缀
- ✅ 支持前端单页应用路由刷新
- ✅ 配置Vite代理转发API请求

### 优化改进

#### 1. UI/UX 优化
- ✅ 精简创建任务入口，统一到导航栏
- ✅ 降低详情页刷新频率（5秒→10秒）
- ✅ 修复刷新时页面抖动问题
- ✅ 添加自动刷新状态指示器
- ✅ 优化文件卡片布局

#### 2. 错误处理
- ✅ 失败文件不显示预览按钮
- ✅ 字幕下载失败时显示友好提示
- ✅ 文件级别的错误信息展示
- ✅ 改进错误反馈机制

#### 3. 代码优化
- ✅ 数据模型增强（TaskList、TaskFile）
- ✅ 数据库Schema更新（task_files 表增加状态字段）
- ✅ 改进后台任务处理逻辑
- ✅ 优化API响应结构

### 技术变更

#### 后端
- 新增 `TaskListResponse` 模型（支持分页）
- `TaskList` 模型增加下载配置字段
- `TaskFile` 模型增加状态和错误信息字段
- 新增单文件重试后台任务
- 所有API端点增加 `/api` 前缀
- 实现SPA fallback路由

#### 前端
- 任务列表改用表格展示
- 实现客户端分页控制
- 新增媒体播放器组件
- 新增字幕查看器组件
- 优化任务详情页面布局
- 改进自动刷新逻辑

#### 数据库
- 新增迁移脚本 `migrations/add_file_status.sql`
- `task_files` 表增加 `status` 和 `error_message` 字段

### 修复问题

#### 1. 预览按钮无效
- **问题**: 点击预览按钮没有反应
- **修复**: 增加滚动到播放器并自动播放功能
- **影响**: 提升用户体验

#### 2. 字幕显示问题
- **问题**: 列表显示有字幕标签，但详情页没有字幕内容
- **根因**: 字幕下载失败但前端没有正确处理
- **修复**: 
  - 检查任务配置和实际文件
  - 字幕不存在时显示友好提示
  - 区分加载中和下载失败状态

#### 3. 资源类型标签不显示
- **问题**: 任务列表的资源类型标签不显示
- **根因**: API未返回下载配置字段
- **修复**: 
  - 后端查询增加配置字段
  - 更新数据模型
  - 重新构建和部署

### 部署说明

#### 数据库迁移
```bash
# 运行迁移脚本
docker-compose exec postgres psql -U youtube -d youtube_tasks -f /path/to/migrations/add_file_status.sql
```

#### 构建和重启
```bash
# 重新构建镜像
docker-compose build youtube-dl-api

# 重启服务
docker-compose up -d
```

### 开发工具

#### 新增脚本
- `start_dev.sh` - 本地开发环境启动脚本
- `frontend/README_DEV.md` - 前端开发文档

### 已知问题

1. **字幕下载限制**
   - YouTube 有请求频率限制（429错误）
   - 部分视频需要登录验证
   - 建议配置有效的 Cookies 文件

2. **浏览器自动播放限制**
   - 部分浏览器禁止自动播放媒体
   - 用户可能需要手动点击播放

### 下一步计划

- [ ] 实现批量任务操作
- [ ] 增加任务筛选和搜索功能
- [ ] 优化大文件下载性能
- [ ] 增加下载进度实时推送
- [ ] 支持更多视频平台

---

## [v3.0.0] - 2025-10-27

### 初始功能
- YouTube 视频片段下载
- 视频、音频、字幕分离下载
- 字幕烧录功能
- 任务管理系统
- PostgreSQL 数据持久化
- Docker 容器化部署
- Vue.js 前端界面

---

**格式说明**:
- ✅ 已完成
- 🚧 进行中
- ⏸️ 暂停
- ❌ 已取消
- [ ] 计划中
