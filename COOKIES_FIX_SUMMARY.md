# Cookie 配置修复总结

## ✅ 已完成的修复

### 1. Cookie 参数传递问题 
**问题**: 代码使用 `--cookies-from-browser chrome`，但 Docker 容器内没有 Chrome 浏览器
**修复**: 改为使用本地 cookies 文件 `--cookies /app/cookies/Cookies`

### 2. 参数顺序问题
**问题**: 使用 `insert()` 方法导致参数顺序混乱
**修复**: 使用 `extend()` 方法正确添加参数

### 3. yt-dlp 输出文件名问题
**问题**: 视频/音频分离流导致"Fixed output name but more than one file to download"错误
**修复**: 使用 `%(ext)s` 模板让 yt-dlp 自动处理文件扩展名

### 4. yt-dlp 覆盖 Cookies 文件问题
**问题**: yt-dlp 在退出时会保存 cookies，覆盖原始文件
**修复**: 
- 创建 `entrypoint.sh` 启动脚本
- 在容器启动时复制 cookies 到 `/tmp/cookies_youtube`
- yt-dlp 使用临时文件，原始文件不会被破坏

### 5. Python 版本问题
**问题**: Python 3.9 已被 yt-dlp 弃用
**修复**: 升级到 Python 3.11

## ⚠️ 需要用户操作

### 重要：Cookies 文件已被损坏

您的 `cookies/Cookies` 文件已被 yt-dlp 覆盖，需要重新导出：

#### 重新导出 Cookies 的步骤：

1. **安装浏览器扩展**
   - Chrome: "Get cookies.txt LOCALLY"
   - Firefox: "cookies.txt"

2. **导出 Cookies**
   - 访问 https://www.youtube.com
   - 确保已登录
   - 使用扩展导出 cookies
   - 保存为 `cookies/Cookies` 文件（Netscape 格式）

3. **重新构建并启动服务**
   ```bash
   cd /Users/liuwei/Github/youtube
   docker-compose build youtube-dl-api
   docker-compose up -d
   ```

## 📋 修改的文件清单

1. `src/downloader/config.py` - 添加 `cookies_file` 参数
2. `src/downloader/video.py` - 修复 cookie 传递和文件名模板
3. `src/downloader/subtitle.py` - 修复 cookie 传递
4. `src/youtube_downloader.py` - 添加 cookies 参数支持
5. `app.py` - 配置 COOKIES_FILE 环境变量
6. `Dockerfile` - 升级 Python、添加启动脚本
7. `entrypoint.sh` - 新文件：复制 cookies 到临时位置
8. `docker-compose.yaml` - 移除 cookies 目录的只读限制

## 🎯 预期效果

修复后应该看到：
- ✅ 没有 "could not find chrome cookies database" 错误
- ✅ 没有 "Python version 3.9 has been deprecated" 警告
- ✅ 没有 "Sign in to confirm you're not a bot" 错误
- ✅ 视频/音频/字幕正常下载

## 🔍 故障排除

### 如果仍然出现 "Sign in to confirm" 错误：

1. 确认 cookies 文件格式正确（Netscape 格式）
2. 确认 cookies 未过期（重新导出）
3. 查看容器日志：
   ```bash
   docker-compose logs youtube-dl-api --tail 100
   ```

### 查看 cookies 是否正确加载：

```bash
docker exec youtube-dl-api cat /tmp/cookies_youtube | head -5
```

应该看到完整的 cookies 内容，而不是 "This file is generated by yt-dlp"。

## 📝 测试命令

```bash
curl -X POST "http://localhost:8000/download" \
  -H "Content-Type: application/json" \
  -d '{
    "url": "https://www.youtube.com/watch?v=jNQXAC9IVRw",
    "start_time": "00:05",
    "end_time": "00:15",
    "download_video": true,
    "download_audio": false,
    "download_subtitles": false
  }'
```

查看任务状态：
```bash
# 替换 TASK_ID 为实际的任务 ID
curl "http://localhost:8000/tasks/TASK_ID"
```

